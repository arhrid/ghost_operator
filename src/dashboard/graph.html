<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ghost Operator — Knowledge Graph</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/3d-force-graph@1.73.3/dist/3d-force-graph.min.js"></script>
  <style>
    :root {
      --bg: #0c0c12;
      --surface: #15151e;
      --border: #25253a;
      --text: #e0e0e8;
      --text-dim: #8888a0;
      --text-muted: #6a6a82;
      --accent: #2dd4bf;
      --accent-glow: rgba(45,212,191,0.15);
      --green: #34d399;
      --yellow: #fbbf24;
      --red: #ef4444;
      --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      --font-mono: 'SF Mono', 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ── Header ─────────────────────────────────────────── */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 24px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      z-index: 5;
      background: var(--bg);
    }

    .top-bar a {
      color: var(--text-dim);
      text-decoration: none;
      font-size: 12px;
      transition: color 0.15s;
    }

    .top-bar a:hover { color: var(--text); }

    .top-bar h1 {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.5px;
      color: var(--accent);
    }

    .top-bar .counts {
      font-size: 11px;
      color: var(--text-dim);
    }

    .top-bar .counts span {
      color: var(--text);
      font-weight: 600;
    }

    /* ── Graph canvas ───────────────────────────────────── */
    #graph-container {
      flex: 1;
      min-height: 0;
      position: relative;
    }

    /* ── Controls hint ──────────────────────────────────── */
    .controls-hint {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 10px;
      color: var(--text-dim);
      z-index: 10;
      line-height: 1.6;
      opacity: 0.8;
      transition: opacity 0.3s;
    }
    .controls-hint:hover { opacity: 1; }
    .controls-hint kbd {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 1px 5px;
      font-family: var(--font-mono);
      font-size: 9px;
      color: var(--text);
    }

    /* ── Legend ──────────────────────────────────────────── */
    .legend {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      z-index: 10;
    }

    .legend-title {
      font-size: 10px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 2px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-dim);
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* ── Detail panel ───────────────────────────────────── */
    .detail-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 340px;
      height: 100vh;
      background: var(--surface);
      border-left: 1px solid var(--border);
      transform: translateX(100%);
      transition: transform 0.2s ease;
      z-index: 20;
      display: flex;
      flex-direction: column;
    }

    .detail-panel.open { transform: translateX(0); }

    .detail-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }

    .detail-header h2 {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }

    .detail-close {
      background: none;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      font-size: 18px;
      font-family: var(--font-sans);
      line-height: 1;
    }

    .detail-close:hover { color: var(--text); }

    .detail-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
    }

    .detail-label-tag {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
      color: #fff;
    }

    .detail-section {
      margin-bottom: 14px;
    }

    .detail-section .key {
      font-size: 10px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 3px;
    }

    .detail-section .val {
      font-size: 12px;
      color: var(--text);
      word-break: break-word;
      white-space: pre-wrap;
    }

    .edge-type-tag {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
      color: var(--accent);
      background: var(--accent-glow);
    }

    /* ── Empty state ─────────────────────────────────────── */
    .empty-state {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: var(--text-dim);
    }

    .empty-state h2 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }

    .empty-state p {
      font-size: 12px;
      max-width: 320px;
      line-height: 1.6;
    }

    .empty-state .empty-hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    /* ── Scrollbar ───────────────────────────────────────── */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  </style>
</head>
<body>
  <div class="top-bar">
    <a href="/dashboard/">← Back to Dashboard</a>
    <h1>Knowledge Graph</h1>
    <div class="counts"><span id="nodeCount">0</span> nodes &middot; <span id="edgeCount">0</span> edges</div>
  </div>

  <div id="graph-container"></div>

  <!-- Legend -->
  <div class="legend" id="legend">
    <div class="legend-title">Node Types</div>
    <div class="legend-item"><div class="legend-dot" style="background:#ef4444"></div>Incident</div>
    <div class="legend-item"><div class="legend-dot" style="background:#a78bfa"></div>Service</div>
    <div class="legend-item"><div class="legend-dot" style="background:#fbbf24"></div>Error</div>
    <div class="legend-item"><div class="legend-dot" style="background:#f97316"></div>Root Cause</div>
    <div class="legend-item"><div class="legend-dot" style="background:#34d399"></div>Remediation</div>
    <div class="legend-item"><div class="legend-dot" style="background:#60a5fa"></div>Post-Mortem</div>
  </div>

  <!-- Controls hint -->
  <div class="controls-hint">
    <kbd>Left-drag</kbd> Rotate &nbsp;&middot;&nbsp;
    <kbd>Right-drag</kbd> Pan &nbsp;&middot;&nbsp;
    <kbd>Scroll</kbd> Zoom &nbsp;&middot;&nbsp;
    <kbd>Click</kbd> Inspect
  </div>

  <!-- Detail Panel -->
  <div class="detail-panel" id="detailPanel">
    <div class="detail-header">
      <h2 id="detailTitle">Details</h2>
      <button class="detail-close" onclick="closePanel()">&times;</button>
    </div>
    <div class="detail-body" id="detailBody"></div>
  </div>

  <script>
    const BASE = window.location.origin;
    const NODE_COLORS = {
      Incident:    '#ef4444',
      Service:     '#a78bfa',
      Error:       '#fbbf24',
      RootCause:   '#f97316',
      Remediation: '#34d399',
      PostMortem:  '#60a5fa',
    };
    const DEFAULT_COLOR = '#555566';

    let graph;

    function colorFor(label) {
      return NODE_COLORS[label] || DEFAULT_COLOR;
    }

    function esc(s) {
      const d = document.createElement('div');
      d.textContent = s ?? '';
      return d.innerHTML;
    }

    // ── Fetch graph and render ─────────────────────────────
    async function init() {
      let nodes = [];
      let edges = [];

      try {
        const r = await fetch(`${BASE}/api/graph`);
        const data = await r.json();
        nodes = data.nodes || [];
        edges = data.edges || [];
      } catch {
        // Network error or server unavailable
      }

      document.getElementById('nodeCount').textContent = nodes.length;
      document.getElementById('edgeCount').textContent = edges.length;

      const container = document.getElementById('graph-container');

      if (nodes.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h2>No graph data yet</h2>
            <p>The knowledge graph is built automatically as Ghost Operator handles incidents.</p>
            <div class="empty-hint">Run a scan or simulate an incident from the dashboard to get started.</div>
          </div>
        `;
        document.getElementById('legend').style.display = 'none';
        return;
      }

      // Prepare nodes for 3d-force-graph
      const graphNodes = nodes.map(node => {
        const { id: _neoId, ...props } = node.properties || {};
        return {
          id: node.id,
          label: node.label,
          displayName: node.properties?.title || node.properties?.name || node.label,
          color: colorFor(node.label),
          ...props,
        };
      });

      // Prepare links (3d-force-graph expects "links" with source/target matching node ids)
      const graphLinks = edges.map(edge => ({
        source: edge.source,
        target: edge.target,
        type: edge.type,
      }));

      // ── Initialize 3D graph ────────────────────────────────
      graph = ForceGraph3D()(container)
        .graphData({ nodes: graphNodes, links: graphLinks })
        .backgroundColor('#0c0c12')
        .nodeId('id')
        // Node appearance
        .nodeColor(d => d.color)
        .nodeVal(d => d.label === 'Incident' ? 6 : d.label === 'Service' ? 4 : 2.5)
        .nodeOpacity(0.95)
        .nodeLabel(d => `${d.label}: ${d.displayName}`)
        // Edge appearance
        .linkColor(() => '#5a5a7a')
        .linkWidth(1.2)
        .linkOpacity(0.6)
        .linkDirectionalArrowLength(4)
        .linkDirectionalArrowRelPos(1)
        .linkDirectionalArrowColor(() => '#7a7a9a')
        .linkDirectionalParticles(1)
        .linkDirectionalParticleWidth(1.5)
        .linkDirectionalParticleColor(link => {
          const sourceNode = graphNodes.find(n => n.id === (typeof link.source === 'object' ? link.source.id : link.source));
          return sourceNode ? sourceNode.color : '#5a5a7a';
        })
        .linkLabel(d => d.type)
        // Interactions
        .onNodeClick(node => showNodeDetail(node))
        .onLinkClick(link => showEdgeDetail(link))
        .onBackgroundClick(() => closePanel())
        // Performance
        .warmupTicks(80)
        .cooldownTicks(200);

      // Fit camera after layout settles
      setTimeout(() => {
        graph.zoomToFit(600, 60);
      }, 2000);
    }

    // ── Detail panel ───────────────────────────────────────
    function showNodeDetail(data) {
      const panel = document.getElementById('detailPanel');
      const body = document.getElementById('detailBody');
      const title = document.getElementById('detailTitle');

      title.textContent = 'Node Details';

      const color = colorFor(data.label);

      const skip = new Set(['id', 'label', 'displayName', 'color', '__threeObj', 'index', 'x', 'y', 'z', 'vx', 'vy', 'vz', 'fx', 'fy', 'fz']);
      const props = Object.entries(data).filter(([k, v]) => !skip.has(k) && typeof v !== 'object');

      let html = `<div class="detail-label-tag" style="background:${esc(color)}">${esc(data.label)}</div>`;
      html += `<div class="detail-section"><div class="key">Name</div><div class="val">${esc(data.displayName)}</div></div>`;

      for (const [key, value] of props) {
        html += `<div class="detail-section"><div class="key">${esc(key)}</div><div class="val">${esc(String(value))}</div></div>`;
      }

      body.innerHTML = html;
      panel.classList.add('open');
    }

    function showEdgeDetail(data) {
      const panel = document.getElementById('detailPanel');
      const body = document.getElementById('detailBody');
      const title = document.getElementById('detailTitle');

      title.textContent = 'Relationship';

      const sourceName = typeof data.source === 'object' ? (data.source.displayName || data.source.label) : data.source;
      const targetName = typeof data.target === 'object' ? (data.target.displayName || data.target.label) : data.target;

      let html = `<div class="edge-type-tag">${esc(data.type)}</div>`;
      html += `<div class="detail-section"><div class="key">Source</div><div class="val">${esc(String(sourceName))}</div></div>`;
      html += `<div class="detail-section"><div class="key">Target</div><div class="val">${esc(String(targetName))}</div></div>`;

      body.innerHTML = html;
      panel.classList.add('open');
    }

    function closePanel() {
      document.getElementById('detailPanel').classList.remove('open');
    }

    // ── Keyboard shortcut ──────────────────────────────────
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closePanel();
    });

    // ── Handle resize ──────────────────────────────────────
    window.addEventListener('resize', () => {
      if (graph) {
        const container = document.getElementById('graph-container');
        graph.width(container.clientWidth);
        graph.height(container.clientHeight);
      }
    });

    // ── Init ───────────────────────────────────────────────
    init();
  </script>
</body>
</html>
